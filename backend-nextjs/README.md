# DasTern Backend API

A Next.js 14+ backend API for the DasTern medication management mobile application.

## ğŸ“ Project Structure

```
backend-nextjs/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth/                    # Authentication endpoints
â”‚   â”‚   â”‚   â”œâ”€â”€ register/            # User registration
â”‚   â”‚   â”‚   â”œâ”€â”€ login/               # User login
â”‚   â”‚   â”‚   â”œâ”€â”€ select-role/         # Role selection (patient/doctor/family)
â”‚   â”‚   â”‚   â”œâ”€â”€ complete-profile/    # Profile completion by role
â”‚   â”‚   â”‚   â”œâ”€â”€ refresh/             # Token refresh
â”‚   â”‚   â”‚   â”œâ”€â”€ me/                  # Get current user
â”‚   â”‚   â”‚   â””â”€â”€ profile/             # Update profile
â”‚   â”‚   â”œâ”€â”€ patients/
â”‚   â”‚   â”‚   â””â”€â”€ family/
â”‚   â”‚   â”‚       â””â”€â”€ invite/          # Patient creates family invitation
â”‚   â”‚   â”‚       â””â”€â”€ requests/[id]/   # Approve/reject family requests
â”‚   â”‚   â”œâ”€â”€ family/
â”‚   â”‚   â”‚   â”œâ”€â”€ connect/             # Family member uses invitation code
â”‚   â”‚   â”‚   â””â”€â”€ patient/[patientId]/ # Family views patient data
â”‚   â”‚   â”œâ”€â”€ prescriptions/
â”‚   â”‚   â”‚   â””â”€â”€ upload/              # OCR prescription upload
â”‚   â”‚   â”œâ”€â”€ reminders/
â”‚   â”‚   â”‚   â”œâ”€â”€ create/              # Create medication reminders
â”‚   â”‚   â”‚   â””â”€â”€ [reminderId]/        # View/manage specific reminder
â”‚   â”‚   â””â”€â”€ health/                  # Health check endpoint
â”‚   â”œâ”€â”€ globals.css
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ db.ts                        # PostgreSQL connection pool
â”‚   â”œâ”€â”€ jwt.ts                       # JWT token utilities
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.ts                  # Authentication middlewares
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ medication.model.ts
â”‚   â”‚   â”œâ”€â”€ prescription.model.ts
â”‚   â”‚   â”œâ”€â”€ reminder.model.ts
â”‚   â”‚   â””â”€â”€ types.ts
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ ocr-parser.service.ts    # Prescription OCR parsing
â”‚   â”‚   â””â”€â”€ prescription.service.ts
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ auth.types.ts            # TypeScript auth types
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ response.ts              # Standardized API responses
â”‚   â”‚   â””â”€â”€ permissions.ts           # Permission checking utilities
â”‚   â””â”€â”€ validators/
â”‚       â”œâ”€â”€ auth.validator.ts        # Auth input validation
â”‚       â”œâ”€â”€ doctor.validator.ts      # Doctor profile validation
â”‚       â”œâ”€â”€ family.validator.ts      # Family profile validation
â”‚       â””â”€â”€ patient.validator.ts     # Patient profile validation
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

---

## ğŸ—ï¸ Architecture Overview

### Complete User Onboarding Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           USER ONBOARDING FLOW                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   MOBILE APP     â”‚
                              â”‚   Opens App      â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚     POST /api/auth/register  â”‚
                        â”‚                              â”‚
                        â”‚  {                           â”‚
                        â”‚    "email": "user@email.com",â”‚
                        â”‚    "password": "Pass123!",   â”‚
                        â”‚    "first_name": "John",     â”‚
                        â”‚    "last_name": "Doe"        â”‚
                        â”‚  }                           â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  âœ… Status: "pending"        â”‚
                        â”‚  ğŸ“¦ Returns: Token A         â”‚
                        â”‚  â¡ï¸  Next: select_role       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   ğŸ“± ROLE SELECTION SCREEN   â”‚
                        â”‚                              â”‚
                        â”‚   â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚
                        â”‚   â”‚ ğŸ‘¤  â”‚ â”‚ ğŸ©º  â”‚ â”‚ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§  â”‚  â”‚
                        â”‚   â”‚Patientâ”‚Doctorâ”‚ â”‚Family â”‚  â”‚
                        â”‚   â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
                               â”‚       â”‚        â”‚
                               â–¼       â–¼        â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  POST /api/auth/select-role  â”‚
                        â”‚  Authorization: Bearer TokenAâ”‚
                        â”‚                              â”‚
                        â”‚  { "role": "patient" }       â”‚
                        â”‚  { "role": "doctor" }        â”‚
                        â”‚  { "role": "family_member" } â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  âœ… Status: "role_selected"  â”‚
                        â”‚  ğŸ“¦ Returns: Token B         â”‚
                        â”‚  â¡ï¸  Next: complete_profile  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                           â”‚                           â”‚
           â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PATIENT PROFILE    â”‚  â”‚   DOCTOR PROFILE     â”‚  â”‚  FAMILY PROFILE      â”‚
â”‚                      â”‚  â”‚                      â”‚  â”‚                      â”‚
â”‚ â€¢ meal_schedule      â”‚  â”‚ â€¢ license_number     â”‚  â”‚ â€¢ preferred_         â”‚
â”‚ â€¢ emergency_contact  â”‚  â”‚ â€¢ specialization     â”‚  â”‚   relationship       â”‚
â”‚ â€¢ blood_type         â”‚  â”‚ â€¢ hospital_name      â”‚  â”‚                      â”‚
â”‚ â€¢ allergies          â”‚  â”‚ â€¢ years_experience   â”‚  â”‚                      â”‚
â”‚ â€¢ medical_conditions â”‚  â”‚                      â”‚  â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                         â”‚                         â”‚
           â–¼                         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /complete-profileâ”‚ â”‚ POST /complete-profileâ”‚ â”‚ POST /complete-profileâ”‚
â”‚ Authorization: TokenB â”‚ â”‚ Authorization: TokenB â”‚ â”‚ Authorization: TokenB â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                         â”‚                         â”‚
           â–¼                         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Status: "active"  â”‚  â”‚ âœ… Status:           â”‚  â”‚ âœ… Status: "active"  â”‚
â”‚ ğŸ“¦ Returns: Token C  â”‚  â”‚   "profile_pending"  â”‚  â”‚ ğŸ“¦ Returns: Token C  â”‚
â”‚ â¡ï¸ Next: dashboard   â”‚  â”‚ (Awaiting admin      â”‚  â”‚ â¡ï¸ Next: connect     â”‚
â”‚                      â”‚  â”‚  verification)       â”‚  â”‚ (Link to patient)    â”‚
â”‚ ğŸ‰ CAN USE APP!      â”‚  â”‚ ğŸ“¦ Returns: Token C  â”‚  â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Patient Role Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            PATIENT USER FLOW                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  PATIENT        â”‚
  â”‚  (active)       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                                                      â”‚
           â–¼                                                                      â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  ğŸ“· PRESCRIPTIONS  â”‚     â”‚  â° REMINDERS      â”‚     â”‚  ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ FAMILY        â”‚   â”‚
  â”‚                    â”‚     â”‚                    â”‚     â”‚                    â”‚   â”‚
  â”‚ POST /prescriptionsâ”‚     â”‚ POST /reminders/   â”‚     â”‚ POST /patients/    â”‚   â”‚
  â”‚      /upload       â”‚     â”‚      create        â”‚     â”‚   family/invite    â”‚   â”‚
  â”‚                    â”‚     â”‚                    â”‚     â”‚                    â”‚   â”‚
  â”‚ â€¢ Upload image     â”‚     â”‚ â€¢ Set times        â”‚     â”‚ â€¢ Generate code    â”‚   â”‚
  â”‚ â€¢ OCR extraction   â”‚     â”‚ â€¢ Link medication  â”‚     â”‚ â€¢ Set permissions  â”‚   â”‚
  â”‚ â€¢ Create meds      â”‚     â”‚ â€¢ Toggle on/off    â”‚     â”‚ â€¢ Share with familyâ”‚   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                          â”‚                          â”‚               â”‚
           â”‚                          â”‚                          â”‚               â”‚
           â–¼                          â–¼                          â–¼               â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
  â”‚                        PATIENT DASHBOARD                               â”‚     â”‚
  â”‚                                                                        â”‚     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
  â”‚  â”‚ Today's     â”‚  â”‚ Active      â”‚  â”‚ Family      â”‚  â”‚ AI Health   â”‚   â”‚     â”‚
  â”‚  â”‚ Reminders   â”‚  â”‚ Medications â”‚  â”‚ Members     â”‚  â”‚ Reports     â”‚   â”‚     â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                                                                                  â”‚
                                                                                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”‚  MANAGE FAMILY CONNECTIONS
  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”‚
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    â”‚ GET /patients/family/invite       â”‚
  â”‚    â”‚                                   â”‚
  â”‚    â”‚ View:                             â”‚
  â”‚    â”‚ â€¢ Created invitation codes        â”‚
  â”‚    â”‚ â€¢ Pending connection requests     â”‚
  â”‚    â”‚ â€¢ Active family members           â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚                    â”‚
  â”‚                    â–¼
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    â”‚ PATCH /patients/family/requests/  â”‚
  â”‚    â”‚       {requestId}                 â”‚
  â”‚    â”‚                                   â”‚
  â”‚    â”‚ â€¢ Approve: {"action": "approve"}  â”‚
  â”‚    â”‚ â€¢ Reject:  {"action": "reject"}   â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

### Family Member Role Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FAMILY MEMBER USER FLOW                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  FAMILY MEMBER  â”‚
  â”‚  (active)       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚   First time? Need to connect to a patient
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                     CONNECT TO PATIENT                                 â”‚
  â”‚                                                                        â”‚
  â”‚   Option 1: Enter Code             Option 2: Scan QR Code              â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
  â”‚   â”‚  â”Œâ”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”   â”‚             â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                â”‚
  â”‚   â”‚  â”‚Kâ”‚7â”‚Mâ”‚Nâ”‚3â”‚Pâ”‚   â”‚             â”‚   â”‚ â–„â–„â–„ â–„â–„â–„  â”‚   â”‚                â”‚
  â”‚   â”‚  â””â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”˜   â”‚             â”‚   â”‚ â–ˆ â–„â–„â–„ â–ˆ  â”‚   â”‚                â”‚
  â”‚   â”‚  [  Connect  ]   â”‚             â”‚   â”‚ â–€â–€â–€ â–€â–€â–€  â”‚   â”‚                â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
  â”‚                                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  POST /api/family/connect                                              â”‚
  â”‚  Authorization: Bearer <family-member-token>                           â”‚
  â”‚                                                                        â”‚
  â”‚  {                                                                     â”‚
  â”‚    "invitation_code": "K7MN3P",                                        â”‚
  â”‚    "message": "Hi, I'm your spouse!"                                   â”‚
  â”‚  }                                                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â³ WAITING FOR APPROVAL                                               â”‚
  â”‚                                                                        â”‚
  â”‚  Status: "pending_approval"                                            â”‚
  â”‚  Patient: John Doe                                                     â”‚
  â”‚  Relationship: Spouse                                                  â”‚
  â”‚                                                                        â”‚
  â”‚  "Waiting for John to approve your connection request..."              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚  Patient approves request
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  âœ… CONNECTED!                                                         â”‚
  â”‚                                                                        â”‚
  â”‚  GET /api/family/connect  (Check status)                               â”‚
  â”‚                                                                        â”‚
  â”‚  {                                                                     â”‚
  â”‚    "active_connections": [{                                            â”‚
  â”‚      "patient_id": "...",                                              â”‚
  â”‚      "first_name": "John",                                             â”‚
  â”‚      "last_name": "Doe",                                               â”‚
  â”‚      "can_view_reminders": true,                                       â”‚
  â”‚      "can_view_prescriptions": true,                                   â”‚
  â”‚      "can_manage_reminders": false,                                    â”‚
  â”‚      "can_receive_alerts": true                                        â”‚
  â”‚    }]                                                                  â”‚
  â”‚  }                                                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    FAMILY MEMBER DASHBOARD                             â”‚
  â”‚                                                                        â”‚
  â”‚  Connected Patients:                                                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  ğŸ‘¤ John Doe (Spouse)                                            â”‚  â”‚
  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚
  â”‚  â”‚  â° Today's Reminders: 3                                         â”‚  â”‚
  â”‚  â”‚  ğŸ’Š Active Medications: 5                                        â”‚  â”‚
  â”‚  â”‚  âš ï¸  Missed Yesterday: 1                                         â”‚  â”‚
  â”‚  â”‚                                                                  â”‚  â”‚
  â”‚  â”‚  [View Details]  [View Reminders]                                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ACCESS PATIENT DATA (Based on Permissions)                            â”‚
  â”‚                                                                        â”‚
  â”‚  GET /api/family/patient/{patientId}                                   â”‚
  â”‚                                                                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚  Permission         â”‚ Allowed â”‚ Data Access                    â”‚   â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
  â”‚  â”‚ can_view_reminders  â”‚   âœ…    â”‚ View reminders & logs          â”‚   â”‚
  â”‚  â”‚ can_view_prescriptionsâ”‚ âœ…   â”‚ View prescription list         â”‚   â”‚
  â”‚  â”‚ can_manage_remindersâ”‚   âŒ    â”‚ Cannot edit/toggle reminders   â”‚   â”‚
  â”‚  â”‚ can_receive_alerts  â”‚   âœ…    â”‚ Get push notifications         â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Complete Family Linking Flow (Both Sides)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PATIENT â†â†’ FAMILY MEMBER CONNECTION FLOW                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     PATIENT (John)                                    FAMILY MEMBER (Jane)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

         â”‚                                                     â”‚
         â”‚  Step 1: Create Invitation                          â”‚
         â–¼                                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚ POST /patients/family/  â”‚                                    â”‚
â”‚       invite            â”‚                                    â”‚
â”‚                         â”‚                                    â”‚
â”‚ {                       â”‚                                    â”‚
â”‚   "relationship_type":  â”‚                                    â”‚
â”‚     "spouse",           â”‚                                    â”‚
â”‚   "permissions": {      â”‚                                    â”‚
â”‚     "can_view_          â”‚                                    â”‚
â”‚       prescriptions":   â”‚                                    â”‚
â”‚       true,             â”‚                                    â”‚
â”‚     "can_view_          â”‚                                    â”‚
â”‚       reminders": true  â”‚                                    â”‚
â”‚   }                     â”‚                                    â”‚
â”‚ }                       â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
            â”‚                                                  â”‚
            â–¼                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚ Response:               â”‚                                    â”‚
â”‚ {                       â”‚                                    â”‚
â”‚   "invitation_code":    â”‚                                    â”‚
â”‚     "K7MN3P",           â”‚â”€â”€â”€â”€ Share via SMS/WhatsApp â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”
â”‚   "qr_code_data": "..." â”‚                                    â”‚   â”‚
â”‚ }                       â”‚                                    â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚   â”‚
            â”‚                                                  â”‚   â”‚
            â”‚                                                  â”‚   â”‚
            â”‚                                                  â–¼   â”‚
            â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
            â”‚                                    â”‚ Step 2: Enter Code      â”‚
            â”‚                                    â”‚                         â”‚
            â”‚                                    â”‚ POST /family/connect    â”‚
            â”‚                                    â”‚                         â”‚
            â”‚                                    â”‚ {                       â”‚
            â”‚                                    â”‚   "invitation_code":    â”‚
            â”‚                                    â”‚     "K7MN3P",           â”‚
            â”‚                                    â”‚   "message": "Hi honey!"â”‚
            â”‚                                    â”‚ }                       â”‚
            â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                                 â”‚
            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€ Notification: "Jane wants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚            to connect!"
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: View Request    â”‚
â”‚                         â”‚
â”‚ GET /patients/family/   â”‚
â”‚     invite              â”‚
â”‚                         â”‚
â”‚ {                       â”‚
â”‚   "pending_requests": [ â”‚
â”‚     {                   â”‚
â”‚       "id": "req-123",  â”‚
â”‚       "first_name":     â”‚
â”‚         "Jane",         â”‚
â”‚       "message":        â”‚
â”‚         "Hi honey!"     â”‚
â”‚     }                   â”‚
â”‚   ]                     â”‚
â”‚ }                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Approve/Reject  â”‚                     â”‚ Step 5: Check Status     â”‚
â”‚                         â”‚                     â”‚                          â”‚
â”‚ PATCH /patients/family/ â”‚                     â”‚ GET /family/connect      â”‚
â”‚   requests/{req-123}    â”‚                     â”‚                          â”‚
â”‚                         â”‚                     â”‚ {                        â”‚
â”‚ {"action": "approve"}   â”‚â”€â”€â”€ Notification â”€â”€â”€â–ºâ”‚   "active_connections":  â”‚
â”‚                         â”‚    "Approved!"      â”‚   [{                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚     "patient_id": "...", â”‚
                                                â”‚     "first_name": "John" â”‚
                                                â”‚   }]                     â”‚
                                                â”‚ }                        â”‚
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                                                            â–¼
                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”‚ âœ… CONNECTED!            â”‚
                                                â”‚                          â”‚
                                                â”‚ Jane can now:            â”‚
                                                â”‚ â€¢ View John's reminders  â”‚
                                                â”‚ â€¢ View John's            â”‚
                                                â”‚   prescriptions          â”‚
                                                â”‚ â€¢ Receive missed med     â”‚
                                                â”‚   alerts                 â”‚
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Permission System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PERMISSION CHECK FLOW                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Request: GET /api/family/patient/{patientId}/reminders
  User: Family Member (Jane)
  Target: Patient (John)

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Incoming        â”‚
                              â”‚  Request         â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  1. Verify JWT Token         â”‚
                        â”‚     Is token valid?          â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                 â”‚
                           NO â–¼              YES â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ 401 Unauthorizedâ”‚  â”‚ Extract userId, â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ role from token â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  2. Is requester = patient?  â”‚
                        â”‚     (Accessing own data)     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                 â”‚
                           YES â–¼              NO â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ âœ… ALLOW        â”‚  â”‚ Continue checks â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  3. Is requester admin?      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                 â”‚
                           YES â–¼              NO â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ âœ… ALLOW        â”‚  â”‚ Continue checks â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  4. Is requester a doctor    â”‚
                        â”‚     assigned to patient?     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                 â”‚
                           YES â–¼              NO â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ âœ… ALLOW        â”‚  â”‚ Continue checks â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  5. Is requester a family    â”‚
                        â”‚     member linked to patient?â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                 â”‚
                            NO â–¼             YES â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ 403 Forbidden   â”‚  â”‚ Check specific  â”‚
                   â”‚ "Not connected" â”‚  â”‚ permission      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  6. Has required permission? â”‚
                        â”‚     (can_view_reminders)     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                 â”‚
                            NO â–¼             YES â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ 403 Forbidden   â”‚  â”‚ âœ… ALLOW        â”‚
                   â”‚ "Permission     â”‚  â”‚                 â”‚
                   â”‚  denied"        â”‚  â”‚ Return data     â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Database Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATABASE ENTITY RELATIONSHIPS                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚      users       â”‚
                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                            â”‚ id (PK)          â”‚
                            â”‚ email            â”‚
                            â”‚ password_hash    â”‚
                            â”‚ first_name       â”‚
                            â”‚ last_name        â”‚
                            â”‚ role â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–º patientâ”‚doctorâ”‚family_memberâ”‚admin
                            â”‚ onboarding_statusâ”‚â”€â”€â”€â–º pendingâ”‚role_selectedâ”‚active
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                        â”‚                        â”‚
            â–¼                        â–¼                        â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ patient_profiles â”‚    â”‚ doctor_profiles  â”‚    â”‚family_member_profilesâ”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ user_id (FK)     â”‚    â”‚ user_id (FK)     â”‚    â”‚ user_id (FK)         â”‚
  â”‚ meal_schedule    â”‚    â”‚ license_number   â”‚    â”‚ linked_patient_id(FK)â”‚â”€â”€â”
  â”‚ blood_type       â”‚    â”‚ specialization   â”‚    â”‚ relationship_type    â”‚  â”‚
  â”‚ allergies []     â”‚    â”‚ hospital_name    â”‚    â”‚ can_view_prescriptionsâ”‚ â”‚
  â”‚ medical_         â”‚    â”‚ verification_    â”‚    â”‚ can_view_reminders   â”‚  â”‚
  â”‚   conditions []  â”‚    â”‚   status         â”‚    â”‚ can_manage_reminders â”‚  â”‚
  â”‚ emergency_contactâ”‚    â”‚ years_experience â”‚    â”‚ can_receive_alerts   â”‚  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                                                                 â”‚
           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚  Patient's prescriptions, medications, reminders
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  prescriptions   â”‚â”€â”€â”€â–ºâ”‚   medications    â”‚â”€â”€â”€â–ºâ”‚medication_remindersâ”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ id (PK)          â”‚    â”‚ id (PK)          â”‚    â”‚ id (PK)            â”‚
  â”‚ patient_id (FK)  â”‚    â”‚ prescription_id  â”‚    â”‚ medication_id (FK) â”‚
  â”‚ doctor_name      â”‚    â”‚ name             â”‚    â”‚ patient_id (FK)    â”‚
  â”‚ image_url        â”‚    â”‚ dosage           â”‚    â”‚ reminder_times []  â”‚
  â”‚ ocr_text         â”‚    â”‚ frequency        â”‚    â”‚ is_active          â”‚
  â”‚ status           â”‚    â”‚ instructions     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    FAMILY INVITATION TABLES                                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  family_invitations  â”‚         â”‚ family_connection_requests â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ id (PK)              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ invitation_id (FK)         â”‚
  â”‚ inviter_id (FK) â”€â”€â”€â”€â”€â”¼â”€â”€â–º usersâ”‚ patient_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º users
  â”‚ invitation_code      â”‚         â”‚ family_member_id (FK) â”€â”€â”€â”€â”€â”¼â”€â”€â–º users
  â”‚ relationship_type    â”‚         â”‚ status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º pendingâ”‚approvedâ”‚rejected
  â”‚ permissions (JSONB)  â”‚         â”‚ message                    â”‚
  â”‚ status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º pendingâ”‚requestedâ”‚approvedâ”‚rejectedâ”‚ created_at          â”‚
  â”‚ expires_at           â”‚         â”‚ responded_at               â”‚
  â”‚ qr_code_data         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚ requested_by (FK)    â”‚
  â”‚ approved_at          â”‚
  â”‚ rejected_at          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Role-Based Access Control

| Middleware | Description | Allowed Roles |
|------------|-------------|---------------|
| `withAuth` | Any authenticated user | All |
| `withRoleSelectedAuth` | User who selected a role | All (after role selection) |
| `withPatientAuth` | Patient-only endpoints | `patient` |
| `withDoctorAuth` | Doctor-only endpoints | `doctor` |
| `withFamilyAuth` | Family member endpoints | `family_member` |
| `withAdminAuth` | Admin-only endpoints | `admin` |

### Response Format

All API responses follow this structure:

```typescript
// Success Response
{
  "success": true,
  "message": "Operation successful",
  "data": { ... },
  "meta": { ... }  // Optional metadata
}

// Error Response
{
  "success": false,
  "message": "Error description",
  "errors": { ... }  // Optional validation errors
}
```

---

## ğŸš€ Getting Started

### Prerequisites

- Node.js 18+
- Docker & Docker Compose
- PostgreSQL 16

### Installation

```bash
# Clone repository
cd DasTern/backend-nextjs

# Install dependencies
npm install

# Set environment variables
cp .env.example .env
```

### Environment Variables

```env
DATABASE_URL=postgresql://dastern:dastern123@postgres:5432/dastern
JWT_SECRET=your-super-secret-jwt-key-change-in-production
JWT_EXPIRES_IN=7d
NODE_ENV=development
```

### Running with Docker

```bash
# Start all services
docker compose up -d

# View logs
docker compose logs -f backend

# Rebuild after changes
docker compose up -d --build
```

### Running Locally

```bash
npm run dev
```

---

## ğŸ“¡ API Endpoints

### Authentication

#### Register User
```http
POST /api/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "first_name": "John",
  "last_name": "Doe",
  "phone_number": "+855123456789"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Registration successful",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "550e8400-e29b-41d4-a716...",
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "email": "user@example.com",
      "first_name": "John",
      "last_name": "Doe",
      "role": null,
      "onboarding_status": "pending"
    }
  },
  "meta": {
    "next_step": "select_role"
  }
}
```

#### Login
```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123!"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "550e8400-e29b-41d4-a716...",
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "email": "user@example.com",
      "role": "patient",
      "onboarding_status": "active"
    }
  },
  "meta": {
    "next_step": "dashboard"
  }
}
```

#### Select Role
```http
POST /api/auth/select-role
Authorization: Bearer <token>
Content-Type: application/json

{
  "role": "patient"
}
```

**Valid roles:** `patient`, `doctor`, `family_member`

**Response:**
```json
{
  "success": true,
  "message": "Role selected successfully",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "role": "patient",
      "onboarding_status": "role_selected"
    }
  },
  "meta": {
    "next_step": "complete_profile",
    "required_fields": ["emergency_contact_name", "emergency_contact_phone"]
  }
}
```

#### Complete Profile

**For Patient:**
```http
POST /api/auth/complete-profile
Authorization: Bearer <token>
Content-Type: application/json

{
  "meal_schedule": {
    "morning": "07:00",
    "noon": "12:00",
    "evening": "18:00",
    "night": "21:00"
  },
  "emergency_contact_name": "Jane Doe",
  "emergency_contact_phone": "+855987654321",
  "blood_type": "O+"
}
```

**For Doctor:**
```http
POST /api/auth/complete-profile
Authorization: Bearer <token>
Content-Type: application/json

{
  "license_number": "MD-2024-12345",
  "specialization": "Cardiology",
  "hospital_name": "Phnom Penh General Hospital",
  "years_of_experience": 10
}
```

**For Family Member:**
```http
POST /api/auth/complete-profile
Authorization: Bearer <token>
Content-Type: application/json

{
  "preferred_relationship": "spouse"
}
```

#### Refresh Token
```http
POST /api/auth/refresh
Content-Type: application/json

{
  "refresh_token": "550e8400-e29b-41d4-a716..."
}
```

#### Get Current User
```http
GET /api/auth/me
Authorization: Bearer <token>
```

---

### Family Connection (Patient Side)

#### Create Invitation Code
```http
POST /api/patients/family/invite
Authorization: Bearer <patient-token>
Content-Type: application/json

{
  "relationship_type": "spouse",
  "permissions": {
    "can_view_prescriptions": true,
    "can_view_reminders": true,
    "can_manage_reminders": false,
    "can_receive_alerts": true
  }
}
```

#### Get Invitations & Pending Requests
```http
GET /api/patients/family/invite
Authorization: Bearer <patient-token>
```

#### Approve/Reject Connection Request
```http
PATCH /api/patients/family/requests/{requestId}
Authorization: Bearer <patient-token>
Content-Type: application/json

{
  "action": "approve"
}
```

---

### Family Connection (Family Member Side)

#### Request Connection with Code
```http
POST /api/family/connect
Authorization: Bearer <family-member-token>
Content-Type: application/json

{
  "invitation_code": "K7MN3P",
  "message": "Hi, I'm your wife!"
}
```

#### Get Connection Status
```http
GET /api/family/connect
Authorization: Bearer <family-member-token>
```

#### Get Patient Data (with permissions)
```http
GET /api/family/patient/{patientId}
Authorization: Bearer <family-member-token>
```

---

### Health Check
```http
GET /api/health
```

---

## ğŸ” Authentication Middleware

### Usage in Route Handlers

```typescript
import { withAuth, withPatientAuth } from '@/lib/middleware/auth';

// Any authenticated user
async function handler(req: NextRequest, auth: JwtPayload) {
  // auth.userId, auth.email, auth.role available
}
export const GET = withAuth(handler);

// Patient only
async function patientHandler(req: NextRequest, auth: JwtPayload) {
  // Only patients can access
}
export const POST = withPatientAuth(patientHandler);
```

---

## ğŸ§ª Testing API Flow

### Complete Patient Onboarding (Postman)

| Step | Method | URL | Body |
|------|--------|-----|------|
| 1 | POST | `/api/auth/register` | `{"email":"patient@test.com","password":"Test123!","first_name":"John","last_name":"Doe"}` |
| 2 | POST | `/api/auth/select-role` | `{"role":"patient"}` + Token from step 1 |
| 3 | POST | `/api/auth/complete-profile` | Patient profile + Token from step 2 |
| 4 | POST | `/api/patients/family/invite` | `{"relationship_type":"spouse"}` + Token from step 3 |

### Complete Family Member Flow (Postman)

| Step | Method | URL | Body |
|------|--------|-----|------|
| 1 | POST | `/api/auth/register` | `{"email":"family@test.com","password":"Test123!","first_name":"Jane","last_name":"Doe"}` |
| 2 | POST | `/api/auth/select-role` | `{"role":"family_member"}` + Token from step 1 |
| 3 | POST | `/api/auth/complete-profile` | `{"preferred_relationship":"spouse"}` + Token from step 2 |
| 4 | POST | `/api/family/connect` | `{"invitation_code":"K7MN3P"}` + Token from step 3 |
| 5 | GET | `/api/family/connect` | Check status + Token from step 3 |

---

## ğŸ› Troubleshooting

### Common Issues

| Issue | Solution |
|-------|----------|
| `MODULE_NOT_FOUND: uuid` | Run `npm install uuid` or use `randomUUID` from `crypto` |
| `relation does not exist` | Run database migrations |
| `invalid input for enum` | Add missing enum value to PostgreSQL |
| `JWT expired` | Use refresh token endpoint |
| `Permission denied` | Check family member permissions |

### Check Docker Logs

```bash
docker compose logs -f backend
docker compose logs -f postgres
```

### Rebuild Container

```bash
docker compose down
docker compose up -d --build
```

---

## ğŸ“ License

MIT License - DasTern Team
